<head src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"><head>
<!DOCTYPE html>>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game of Impostor - Multiplayer</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; background: #1a1a1a; color: white; font-family: sans-serif; overflow: hidden; }
        canvas { display: block; background: #222; border: 2px solid #444; margin: 10px auto; border-radius: 8px; }
        .ui-panel { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.85); padding: 20px; border-radius: 12px; z-index: 10; border: 1px solid #333; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

    <div class="ui-panel">
        <h1 class="text-2xl font-bold mb-2 text-red-500 tracking-wider">GAME OF IMPOSTOR</h1>
        
        <div id="setup-section" class="space-y-3">
            <p class="text-sm text-gray-300">Tvoje ID místnosti (pošli kamarádovi):</p>
            <div id="my-id" class="font-mono text-lg text-yellow-400 bg-black p-2 rounded border border-yellow-900/50 text-center">Načítám kód...</div>
            
            <hr class="border-gray-700 my-4">
            
            <p class="text-sm text-gray-300">Připojit se ke kamarádovi:</p>
            <div class="flex gap-2">
                <input type="text" id="join-id" placeholder="Vlož ID" class="bg-gray-800 border border-gray-600 px-3 py-2 rounded text-white w-40 focus:outline-none focus:border-blue-500">
                <button onclick="connectToPeer()" class="bg-blue-600 hover:bg-blue-700 transition-colors px-4 py-2 rounded font-bold">HRÁT</button>
            </div>
        </div>

        <p id="status" class="mt-4 text-xs text-gray-500 uppercase font-semibold">Stav: Připojování k serveru...</p>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        // --- SÍŤOVÉ NASTAVENÍ (FIX PRO VERCEL/HTTPS) ---
        const peer = new Peer(undefined, {
            host: '0.peerjs.com',
            port: 443,
            secure: true,
            debug: 3 // Vypisuje vše důležité do konzole (F12)
        });

        let conn;
        let players = {};
        let myId;

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        function resizeCanvas() {
            canvas.width = window.innerWidth - 20;
            canvas.height = window.innerHeight - 20;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // Můj lokální hráč (Impostor)
        const me = {
            x: Math.random() * (canvas.width - 50) + 25,
            y: Math.random() * (canvas.height - 50) + 25,
            color: '#ef4444', // Červená
            size: 20
        };

        // --- PEERJS LOGIKA ---

        // 1. Získání vlastního ID od serveru
        peer.on('open', (id) => {
            myId = id;
            document.getElementById('my-id').innerText = id;
            document.getElementById('status').innerText = "Stav: Online";
            players[id] = me;
        });

        // 2. Hostitel: Někdo se připojil ke mně
        peer.on('connection', (connection) => {
            conn = connection;
            setupConnection();
            document.getElementById('status').innerText = "Stav: Hráč připojen";
        });

        // 3. Klient: Já se připojuji k někomu
        function connectToPeer() {
            const targetId = document.getElementById('join-id').value.trim();
            if (!targetId) return;
            
            document.getElementById('status').innerText = "Stav: Vyhledávám...";
            conn = peer.connect(targetId);
            setupConnection();
        }

        // 4. Společné nastavení přenosu dat
        function setupConnection() {
            conn.on('open', () => {
                document.getElementById('status').innerText = "Stav: Spojeno";
                sendPosition(); // Pošleme počáteční pozici
            });

            conn.on('data', (data) => {
                // Přijímáme pozici druhého hráče a ukládáme ji do seznamu
                players[conn.peer] = data;
            });

            conn.on('close', () => {
                document.getElementById('status').innerText = "Stav: Hráč se odpojil";
                delete players[conn.peer];
            });
        }

        // Funkce pro odeslání mé pozice přes síť
        function sendPosition() {
            if (conn && conn.open) {
                conn.send({ x: me.x, y: me.y, color: me.color });
            }
        }

        // --- OVLÁDÁNÍ A POHYB ---

        const keys = {};
        window.addEventListener('keydown', (e) => keys[e.key.toLowerCase()] = true);
        window.addEventListener('keyup', (e) => keys[e.key.toLowerCase()] = false);

        function updateMovement() {
            const speed = 5;
            let moved = false;

            if (keys['arrowup'] || keys['w']) { me.y -= speed; moved = true; }
            if (keys['arrowdown'] || keys['s']) { me.y += speed; moved = true; }
            if (keys['arrowleft'] || keys['a']) { me.x -= speed; moved = true; }
            if (keys['arrowright'] || keys['d']) { me.x += speed; moved = true; }

            // Pokud jsem se pohnul, pošlu novou pozici kamarádovi
            if (moved) sendPosition();
        }

        // --- RENDERING (KRESLENÍ) ---

        function draw() {
            // Vyčistit herní plochu
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Vykreslit mřížku pro lepší orientaci
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 1;
            for(let i=0; i<canvas.width; i+=50) { ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,canvas.height); ctx.stroke(); }
            for(let i=0; i<canvas.height; i+=50) { ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(canvas.width,i); ctx.stroke(); }

            // Vykreslit všechny hráče v seznamu
            for (let id in players) {
                const p = players[id];
                
                // Tělo postavičky
                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.arc(p.x, p.y, 20, 0, Math.PI * 2);
                ctx.fill();
                
                // "Batoh" nebo stín pod hráčem
                ctx.fillStyle = 'rgba(0,0,0,0.3)';
                ctx.fillRect(p.x - 15, p.y + 15, 30, 5);

                // Text nad hlavou
                ctx.fillStyle = id === myId ? '#fbbf24' : 'white';
                ctx.font = 'bold 12px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(id === myId ? "TY (Impostor)" : "HRÁČ", p.x, p.y - 30);
            }

            updateMovement();
            requestAnimationFrame(draw);
        }

        // Spuštění hry
        draw();

        // Ošetření chyb PeerJS
        peer.on('error', (err) => {
            console.error('PeerJS Chyba:', err.type);
            document.getElementById('status').innerText = "Chyba: " + err.type;
            if(err.type === 'peer-運-not-found') alert('Místnost s tímto ID neexistuje.');
        });
    </script>
</body>
</html>
