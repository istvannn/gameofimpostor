<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMPOSTOR - Brute Force Fix</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.4.7/peerjs.min.js"></script>
    <style>
        body { margin: 0; background: #000; color: #0f0; font-family: monospace; overflow: hidden; }
        #ui { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #111; padding: 20px; border: 2px solid #0f0; width: 300px; z-index: 10; text-align: center; }
        input { width: 90%; padding: 10px; margin: 5px 0; background: #222; color: #0f0; border: 1px solid #0f0; }
        button { width: 95%; padding: 10px; margin: 5px 0; cursor: pointer; background: #0f0; color: #000; font-weight: bold; border: none; }
        #log { font-size: 10px; height: 100px; overflow-y: auto; text-align: left; border-top: 1px solid #333; margin-top: 10px; }
        canvas { display: none; }
    </style>
</head>
<body>

    <div id="ui">
        <h3>IMPOSTOR P2P</h3>
        <input type="text" id="nick" placeholder="Jméno" value="Hráč">
        <button onclick="copyId()">1. KOPÍROVAT MOJE ID</button>
        <input type="text" id="myId" readonly>
        <hr>
        <input type="text" id="peerId" placeholder="Vlož ID kámoše">
        <button onclick="connect()">2. PŘIPOJIT SE</button>
        <button id="startBtn" onclick="gameStart()" style="display:none; background: #f0f;">3. START HRY</button>
        <div id="log">Status: Startování...</div>
    </div>

    <canvas id="canvas"></canvas>

    <script>
        const log = (m) => { const l = document.getElementById('log'); l.innerHTML += `> ${m}<br>`; l.scrollTop = l.scrollHeight; };

        // Konfigurace s více STUN servery pro větší šanci na průchod firewallem
        const peer = new Peer(undefined, {
            config: {
                'iceServers': [
                    { url: 'stun:stun.l.google.com:19302' },
                    { url: 'stun:stun1.l.google.com:19302' },
                    { url: 'stun:stun2.l.google.com:19302' },
                    { url: 'stun:stun3.l.google.com:19302' }
                ],
                'sdpSemantics': 'unified-plan'
            }
        });

        let conns = [];
        let players = {};
        const me = { x: 300, y: 300, n: "Hráč", r: "CREWMATE" };

        peer.on('open', id => {
            document.getElementById('myId').value = id;
            log("Server připraven.");
        });

        function copyId() {
            const i = document.getElementById('myId');
            i.select();
            document.execCommand('copy');
            log("ID zkopírováno.");
        }

        function connect() {
            const id = document.getElementById('peerId').value.trim();
            me.n = document.getElementById('nick').value;
            log("Zkouším prorazit k " + id);
            const c = peer.connect(id, { reliable: false }); // Vypnuto reliable pro rychlejší průchod
            setup(c);
        }

        peer.on('connection', c => {
            log("NĚKDO SE PŘIPOJIL!");
            setup(c);
        });

        function setup(c) {
            c.on('open', () => {
                log("!!!! SPOJENO !!!!");
                if(!conns.find(x => x.peer === c.peer)) conns.push(c);
                document.getElementById('startBtn').style.display = 'block';
                
                setInterval(() => {
                    if(c.open) c.send({ x: me.x, y: me.y, n: me.nick });
                }, 50);
            });
            c.on('data', d => {
                if(d.r) { me.r = d.r; run(); }
                else { players[c.peer] = d; }
            });
        }

        function gameStart() {
            const imp = Math.floor(Math.random() * (conns.length + 1));
            conns.forEach((c, i) => {
                c.send({ r: (i === imp ? 'IMPOSTOR' : 'CREWMATE') });
            });
            me.r = (imp === conns.length ? 'IMPOSTOR' : 'CREWMATE');
            run();
        }

        function run() {
            document.getElementById('ui').style.display = 'none';
            const cvs = document.getElementById('canvas');
            cvs.style.display = 'block';
            cvs.width = window.innerWidth;
            cvs.height = window.innerHeight;
            loop();
        }

        const keys = {};
        window.onkeydown = e => keys[e.key.toLowerCase()] = true;
        window.onkeyup = e => keys[e.key.toLowerCase()] = false;

        function loop() {
            const ctx = document.getElementById('canvas').getContext('2d');
            ctx.fillStyle = '#000';
            ctx.fillRect(0,0,innerWidth,innerHeight);

            if(keys['w']) me.y -= 5; if(keys['s']) me.y += 5;
            if(keys['a']) me.x -= 5; if(keys['d']) me.x += 5;

            for(let id in players) {
                draw(ctx, players[id].x, players[id].y, "#555", players[id].n);
            }
            draw(ctx, me.x, me.y, me.r === 'IMPOSTOR' ? "#f00" : "#0f0", me.n + " (TY)");
            requestAnimationFrame(loop);
        }

        function draw(ctx, x, y, c, n) {
            ctx.fillStyle = c;
            ctx.beginPath(); ctx.arc(x, y, 15, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = "#fff"; ctx.fillText(n || "Hráč", x-10, y-20);
        }
    </script>
</body>
</html>
